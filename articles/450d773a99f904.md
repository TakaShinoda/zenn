---
title: 'Google Analytics 4 ã‚’ä½¿ã£ã¦äººæ°—è¨˜äº‹ã‚’å–å¾—ã—microCMSã«é€£æºã™ã‚‹'
emoji: 'ğŸ—’'
type: 'tech' # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ['microcms', 'googleanalytics', 'nextjs']
published: true
---

# ã¯ã˜ã‚ã«

ç¾åœ¨ã€Next.js ã¨ microCMS ã‚’ä½¿ã£ã¦ã‚µã‚¤ãƒˆã‚’æ§‹ç¯‰ã—ã¦ã„ã¾ã™ã€‚

ãã®ã‚µã‚¤ãƒˆã« Google Analytics ã‚’å°å…¥ã—ã€äººæ°—è¨˜äº‹ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚’ä½œã‚Šã¾ã—ãŸã€‚

![](https://storage.googleapis.com/zenn-user-upload/356e48dc3f9b-20220604.png)

Google Analytics ã‚’ä½¿ã£ã¦äººæ°—è¨˜äº‹ã‚’å–å¾—ã— microCMS ã«é€£æºã™ã‚‹æ–¹æ³•ã¯ã€
ä¸‹è¨˜ã®è¨˜äº‹ã«ã¦ã‚ã‹ã‚Šã‚„ã™ãè§£èª¬ã—ã¦ã‚ã‚Šã¾ã™ã€‚

https://blog.microcms.io/populars-from-google-analytics/

ã§ã™ãŒã€ä»Šå› Google Analytics 4 ã‚’ä½¿ç”¨ã—ã¦ãŠã‚Šã€
Google Analytics 4 ã‹ã‚‰ã€Œãƒ“ãƒ¥ãƒ¼ã€ãŒç„¡ããªã£ãŸãŸã‚äººæ°—è¨˜äº‹ã‚’å–å¾—ã™ã‚‹æ–¹æ³•ãŒå¤‰ã‚ã‚Šã¾ã—ãŸã€‚

ä»¥ä¸‹ã€Google Analytics 4 ã§äººæ°—è¨˜äº‹ã‚’å–å¾—ã— microCMS ã«é€£æºã™ã‚‹æ–¹æ³•ã‚’è¨˜ã—ã¾ã™ã€‚

# å‰æ

å‰ææ¡ä»¶ã¨ã—ã¦ä¸‹è¨˜è¨˜äº‹ã®ã‚ˆã†ã«ã€éµãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã‚„ Google Analytics ã§ã®æ¨©é™ä»˜ä¸ã‚’ãŠã“ãªã£ã¦ã„ã‚‹ã‚‚ã®ã¨ã—ã¾ã™ã€‚

https://dev.classmethod.jp/articles/ga-api-v4/

# Google Analytics ã«æ¥ç¶š

çµè«–ã€Google Analytics ã«æ¥ç¶šã™ã‚‹ãŸã‚ã€Google Analytics Data API (GA4)ã‚’ä½¿ç”¨ã—ã¾ã—ãŸã€‚

https://developers.google.com/analytics/devguides/reporting/data/v1/rest

ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã« Google Analytics Data: Node.js Client ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚

```
npm install @google-analytics/data
```

https://www.npmjs.com/package/@google-analytics/data

```js: getPopularArticles.js
const { BetaAnalyticsDataClient } = require('@google-analytics/data')
const credentialsJsonPath = '../credential.json'

const analyticsDataClient = new BetaAnalyticsDataClient({
  keyFilename: credentialsJsonPath,
})

;(async () => {
  const [response] = await analyticsDataClient.runReport({
    property: `properties/${propertyId}`,
    dateRanges: [
      {
        startDate: '8daysAgo',
        endDate: '1daysAgo',
      },
    ],
    dimensions: [
      {
        name: 'pagePath',
      },
    ],
    dimensionFilter: {
      filter: {
        // è¨˜äº‹ã®URLã¯ /article/${contentId} ãªã®ã§ãã‚Œä»¥å¤–ã®URLã‚’é™¤ããŸã„ãŸã‚ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
        stringFilter: {
          value: 'article',
          matchType: 'CONTAINS',
        },
        fieldName: 'pagePath',
      },
    },
  })
```

ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã®è©³ç´°ã¯ä¸‹è¨˜ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’å‚è€ƒã«ã—ã¦ãã ã•ã„ã€‚
https://developers.google.com/analytics/devguides/reporting/data/v1/rest/v1beta/properties

ä¸Šè¨˜å®Ÿè¡Œã™ã‚‹ã¨ãƒ‡ãƒ¼ã‚¿ãŒå–å¾—ã§ãã¾ã™ã€‚

```
{
  dimensionHeaders: [ { name: 'pagePath' } ],
  metricHeaders: [],
  rows: [
    { dimensionValues: [Array], metricValues: [] },
    { dimensionValues: [Array], metricValues: [] },
    { dimensionValues: [Array], metricValues: [] },
    { dimensionValues: [Array], metricValues: [] }
  ],
  totals: [],
  maximums: [],
  minimums: [],
  rowCount: 4,
  metadata: {
    dataLossFromOtherRow: false,
    currencyCode: 'JPY',
    _currencyCode: 'currencyCode',
    timeZone: 'Asia/Tokyo',
    _timeZone: 'timeZone'
  },
  propertyQuota: null,
  kind: 'analyticsData#runReport'
}
```

# microCMS ã«ãƒ‡ãƒ¼ã‚¿ã‚’æ›¸ãè¾¼ã‚€

microCMS ã«ãƒ‡ãƒ¼ã‚¿ã‚’æ›¸ãè¾¼ã‚€ã®ã¯ã€å‚è€ƒè¨˜äº‹ã®[ã€ŒGoogle Analytics ã‚’ä½¿ã£ã¦äººæ°—è¨˜äº‹ã‚’å–å¾—ã— microCMS ã«é€£æºã™ã‚‹ã€](https://blog.microcms.io/populars-from-google-analytics/)ã¨åŒã˜ã§ã™ã€‚

ä¸Šè¨˜ã§å–å¾—ã—ãŸãƒ‡ãƒ¼ã‚¿ã‹ã‚‰ã€ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ ID ã®é…åˆ—ã‚’ä½œæˆã— PATCH ã—ã¾ã™ã€‚

```js: getPopularArticles.js
if (response) {
  const rankedPaths = response.rows.map((row) => row.dimensionValues)
	const maybeContentIds = rankedPaths.flat()
    .map((rank) => rank.value)
    .map((r) => r.replace('/article/', ''))

  //microCMSã¸ã®PATCH
  const result = await fetch('https://<YOUR_SERVICE>.microcms.io/api/v1/popular', {
    method: 'PATCH',
    headers: {
      'Content-Type': 'application/json',
      'X-MICROCMS-API-KEY': MICROCMS_API_KEY,
    },
    body: JSON.stringify({ popular: maybeContentIds }),
  })
}
```

# ãŠã‚ã‚Šã«

Google Analytics ã¨ microCMS ã‚’ä½¿ã£ã¦ã€äººæ°—è¨˜äº‹ä¸€è¦§ã‚’ä½œæˆã§ãã¾ã—ãŸã€‚
ã‚ã¨ã¯ã€GitHub Actions ã‚’ä½¿ã£ã¦æ¯é€±æ—¥æ›œæ—¥ãªã©å®šæœŸçš„ã«å®Ÿè¡Œã™ã‚‹ã“ã¨ã§ã„ã„æ„Ÿã˜ã«ãªã‚Šãã†ã§ã™ã€‚
