---
title: 'supabase'
emoji: '🦌'
type: 'tech' # tech: 技術記事 / idea: アイデア
topics: ['supabase']
published: false
---

:::message
この記事は [弁護士ドットコム Advent Calendar 2021](https://qiita.com/advent-calendar/2021/bengo4com) の 18 日目の記事です。
:::

# はじめに

こんにちは。
弁護士ドットコム株式会社 クラウドサイン事業本部 プロダクト部の篠田([@tttttt_621_s](https://twitter.com/tttttt_621_s))です。

<!-- 前日は、[@komtaki](https://qiita.com/komtaki)さんの XXXXX でした！ -->

前日は、XXXXX さんの XXXXX でした！

私は、個人開発の際に Firebase を使うことがあるのですが、最近 Supabase というものを知ってこの機会にさわってみました。
また、並行して Zenn への投稿も初めてやってみました。

よろしくお願いします。

# Supabase とは

Firebase Alternative と公式サイトで謳ってあるオープンソースの Baas です。
具体的には下記の機能があります。

- Database(PostgreSQL)
- Authentication
- Storage
- Functions(Comming soon) <!-- <- 2021/12/03 のステータス -->

https://supabase.com/

また、11/29 から 5 日間 [Supabase Launch Week III: Holiday Special](https://supabase.com/blog/2021/11/26/supabase-launch-week-the-trilogy) が行われていました。

- Monday: Community Day
- Tuesday: Dashboard Surprise
- Wednesday: Realtime Updates
- Thursday: A new player enters the game
- Friday: (One more thing)

Supabase コミュニティを構成するコミュニティと彼らのアップデートの紹介、新機能の概要、買収などありました。

# 環境構築

## Supabase に登録・プロジェクト作成

- 公式サイトから「Start your project」を選択

![画像1](https://storage.googleapis.com/zenn-user-upload/9e14030a059a-20211204.png)

- GitHub でログイン後、「New Project」を選択

![画像2](https://storage.googleapis.com/zenn-user-upload/87faa5d13928-20211204.png)

![画像3](https://storage.googleapis.com/zenn-user-upload/e6dd877255f2-20211204.png)

- プロジェクト名とパスワードを入力し、リージョンを指定します。 (Tokyo も存在します。)

![画像4](https://storage.googleapis.com/zenn-user-upload/143ee560077f-20211204.png)

<!-- # チュートリアルをやってみる -->

## データベーススキーマの設定

- 今回は「User Management Starter」のクイックスタートを使用します。

![User Management Starter](https://storage.googleapis.com/zenn-user-upload/75dc4c0a38ed-20211211.png)

- 「RUN」を押下してクエリを実行します。

![クエリ実行](https://storage.googleapis.com/zenn-user-upload/9ddd5a7db4d8-20211211.png)

- テーブルが作成されます。

![テーブル](https://storage.googleapis.com/zenn-user-upload/20bbeb38bd85-20211211.png)

<!-- Get the API Keys# -->

## API キーの取得

- 「設定」->「API」から Config URL と API keys を確認します。

![API setting](https://storage.googleapis.com/zenn-user-upload/2808f68f4684-20211212.png)

## Next.js で新規プロジェクト作成

- `create-next-app`を使って、プロジェクトを新規作成します。

```
npx create-next-app@latest --typescript
```

- supabase-js をインストールします

```bash
npm install @supabase/supabase-js
```

https://github.com/supabase/supabase-js

- Next.js のプロジェクト配下に`.env.local`ファイルを作成し、先程の Config URL と API keys を記述します。

```text: .env.local
# Config URL
NEXT_PUBLIC_SUPABASE_URL=https://XXXXXXXXXXXXXXXXXXXX.supabase.co
# API keys
NEXT_PUBLIC_SUPABASE_ANON_KEY=XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
```

```ts: supabaseClient.ts
import { createClient } from '@supabase/supabase-js'

const supabaseUrl= process.env.NEXT_PUBLIC_SUPABASE_URL as string
const supabaseAnonKey = process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY as string

export const supabase = createClient(supabaseUrl, supabaseAnonKey)
```

# 機能作成

## サインイン

ユーザーは E メールまたは OAuth のいずれかでサインインできます。
パスワードなしでメールを提供した場合、ユーザーにはマジックリンクが送信されます。(今回はこれ)
デフォルトでは、60 秒に 1 回マジックリンクを要求できます。

```tsx: Auth.tsx
const { error } = await supabase.auth.signIn({ email })
```

:::details email に useState を使ってフォームに入力されたアドレスを入れています。

```tsx: Auth.tsx
// ここに詳細を表示する
```

:::

:::details パスワードありの場合

```tsx: Auth.tsx
const { error } = await supabase.auth.signIn({
  email: 'example@email.com',
  password: 'example-password',
})
```

:::

実際にデフォルトでは、下記のようなメールが送られてきました。
![マジックリンクのメール](https://storage.googleapis.com/zenn-user-upload/9e1dd99cdf7e-20211206.png)

<!-- メールの内容も変更でき、実際に変更してみました。 -->
<!-- ここうまくいかない -->
<!-- 確認中 -->

サードパーティのプロバイダを利用したサインインは主に下記をサポートしています。(一部抜粋)

- GitHub
- Google
- GitLab
- Bitbucket

https://supabase.com/docs/guides/auth/intro

## データベースの型情報ファイルの生成

- openapi-typescript を使用して、型情報のファイルを生成できます。

```
npx openapi-typescript https://your-project.supabase.co/rest/v1/?apikey=your-anon-key --output types/supabase.ts
```

:::details 今回実際に生成されたファイル

```ts: types/supabase.ts
/**
 * This file was auto-generated by openapi-typescript.
 * Do not make direct changes to the file.
 */

export interface paths {
  "/": {
    get: {
      responses: {
        /** OK */
        200: unknown;
      };
    };
  };
  "/profiles": {
    get: {
      parameters: {
        query: {
          id?: parameters["rowFilter.profiles.id"];
          updated_at?: parameters["rowFilter.profiles.updated_at"];
          username?: parameters["rowFilter.profiles.username"];
          avatar_url?: parameters["rowFilter.profiles.avatar_url"];
          website?: parameters["rowFilter.profiles.website"];
          /** Filtering Columns */
          select?: parameters["select"];
          /** Ordering */
          order?: parameters["order"];
          /** Limiting and Pagination */
          offset?: parameters["offset"];
          /** Limiting and Pagination */
          limit?: parameters["limit"];
        };
        header: {
          /** Limiting and Pagination */
          Range?: parameters["range"];
          /** Limiting and Pagination */
          "Range-Unit"?: parameters["rangeUnit"];
          /** Preference */
          Prefer?: parameters["preferCount"];
        };
      };
      responses: {
        /** OK */
        200: {
          schema: definitions["profiles"][];
        };
        /** Partial Content */
        206: unknown;
      };
    };
    post: {
      parameters: {
        body: {
          /** profiles */
          profiles?: definitions["profiles"];
        };
        query: {
          /** Filtering Columns */
          select?: parameters["select"];
        };
        header: {
          /** Preference */
          Prefer?: parameters["preferReturn"];
        };
      };
      responses: {
        /** Created */
        201: unknown;
      };
    };
    delete: {
      parameters: {
        query: {
          id?: parameters["rowFilter.profiles.id"];
          updated_at?: parameters["rowFilter.profiles.updated_at"];
          username?: parameters["rowFilter.profiles.username"];
          avatar_url?: parameters["rowFilter.profiles.avatar_url"];
          website?: parameters["rowFilter.profiles.website"];
        };
        header: {
          /** Preference */
          Prefer?: parameters["preferReturn"];
        };
      };
      responses: {
        /** No Content */
        204: never;
      };
    };
    patch: {
      parameters: {
        query: {
          id?: parameters["rowFilter.profiles.id"];
          updated_at?: parameters["rowFilter.profiles.updated_at"];
          username?: parameters["rowFilter.profiles.username"];
          avatar_url?: parameters["rowFilter.profiles.avatar_url"];
          website?: parameters["rowFilter.profiles.website"];
        };
        body: {
          /** profiles */
          profiles?: definitions["profiles"];
        };
        header: {
          /** Preference */
          Prefer?: parameters["preferReturn"];
        };
      };
      responses: {
        /** No Content */
        204: never;
      };
    };
  };
}

export interface definitions {
  profiles: {
    /**
     * Note:
     * This is a Primary Key.<pk/>
     */
    id: string;
    updated_at?: string;
    username?: string;
    avatar_url?: string;
    website?: string;
  };
}

export interface parameters {
  /** Preference */
  preferParams: "params=single-object";
  /** Preference */
  preferReturn: "return=representation" | "return=minimal" | "return=none";
  /** Preference */
  preferCount: "count=none";
  /** Filtering Columns */
  select: string;
  /** On Conflict */
  on_conflict: string;
  /** Ordering */
  order: string;
  /** Limiting and Pagination */
  range: string;
  /** Limiting and Pagination */
  rangeUnit: string;
  /** Limiting and Pagination */
  offset: string;
  /** Limiting and Pagination */
  limit: string;
  /** profiles */
  "body.profiles": definitions["profiles"];
  "rowFilter.profiles.id": string;
  "rowFilter.profiles.updated_at": string;
  "rowFilter.profiles.username": string;
  "rowFilter.profiles.avatar_url": string;
  "rowFilter.profiles.website": string;
}

export interface operations {}

export interface external {}

```

:::

## サインインしたユーザの情報表示

```tsx: Account.tsx
const user = supabase.auth.user()

let { data, error, status } = await supabase
    .from<definitions['profiles']>('profiles')
    .select(`username, website, avatar_url`)
    .eq('id', user.id)
    .single()
```

# おわりに

明日は、XXXXX さんで XXXXXX です！
